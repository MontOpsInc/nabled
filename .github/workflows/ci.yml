name: CI

concurrency:
  group: ${{ github.repository }}-${{ github.head_ref || github.sha }}-${{ github.workflow }}
  cancel-in-progress: true

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  checks: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  RUSTFLAGS: '-C debuginfo=line-tables-only -C incremental=false'

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.changes.outputs.code }}
    steps:
    - uses: actions/checkout@v6
    - uses: dorny/paths-filter@master
      id: changes
      with:
        predicate-quantifier: 'every'
        filters: |
          code:
            - '**'
            - '!**.md'
            - '!docs/**'
            - '!.claude/**'
            - '!.gitignore'
            - '!LICENSE'
            - '!.github/workflows/pr.yml'
            - '!.github/workflows/release.yml'
            - '!.github/workflows/security.yml'
            - '!.github/dependabot.yml'
            - '!.github/labeler.yml'

  check:
    name: Check
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.code == 'true'
    steps:
    - uses: actions/checkout@v6

    - name: Install Rust stable
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy
        targets: x86_64-unknown-linux-gnu

    - name: Install Rust nightly (for formatting)
      uses: dtolnay/rust-toolchain@nightly
      with:
        components: rustfmt

    - name: Install LAPACK/BLAS system libraries (for all-features clippy)
      run: |
        sudo apt-get update
        sudo apt-get install -y pkg-config libopenblas-dev liblapack-dev

    - name: Check formatting
      run: cargo +nightly fmt -- --check

    - name: Run clippy
      run: cargo +stable clippy --profile ci --all-features --all-targets -- -D warnings

    - name: Verify Linux LAPACK kernel path compiles
      run: cargo +stable check --profile ci --features lapack-kernels --target x86_64-unknown-linux-gnu

    - name: Generate backend capability reports
      run: |
        cargo +stable run --bin backend_capability_report -- --output-dir coverage/backend-capabilities/baseline
        cargo +stable run --features lapack-kernels --bin backend_capability_report -- --output-dir coverage/backend-capabilities/lapack-linux

    - name: Publish backend capability summary
      run: |
        cat coverage/backend-capabilities/baseline/summary.md >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        cat coverage/backend-capabilities/lapack-linux/summary.md >> "$GITHUB_STEP_SUMMARY"

    - name: Upload backend capability artifacts
      uses: actions/upload-artifact@v4
      with:
        name: backend-capabilities-${{ github.run_id }}
        path: coverage/backend-capabilities

  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.code == 'true'
    strategy:
      matrix:
        features:
          # TODO: Remove - (George) This is placeholder, there are not features currently
          - "test-utils"
    steps:
    - uses: actions/checkout@v6

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}-${{ github.job }}-${{ strategy.job-index }}

    - name: Run unit tests
      run: |
        cargo test --lib --profile ci -F ${{ matrix.features }} -- --nocapture --show-output

  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.code == 'true'
    strategy:
      matrix:
        features:
          - "test-utils"
    steps:
    - uses: actions/checkout@v6

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}-${{ github.job }}-${{ strategy.job-index }}

    - name: Run integration tests
      run: |
        cargo test --profile ci -F ${{ matrix.features }} --test "integration" -- --nocapture --show-output

    # TODO: Convert doc test to tests and reenable
    # - name: Run doc tests
    #   run: cargo +${{ matrix.rust }} test --doc --all-features

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.code == 'true'
    steps:
    - uses: actions/checkout@v6

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install cargo-llvm-cov
      uses: taiki-e/install-action@cargo-llvm-cov

    - name: Generate code coverage
      run: |
        cargo llvm-cov clean --workspace
        cargo llvm-cov --lcov --no-report --ignore-filename-regex "(examples).*" -F test-utils
        cargo llvm-cov report --lcov --output-path lcov.info

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: lcov.info
        fail_ci_if_error: true
        disable_telem: true

  benchmark-smoke:
    name: Benchmark Smoke
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.code == 'true'
    steps:
    - uses: actions/checkout@v6

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install just
      uses: taiki-e/install-action@just

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}-${{ github.job }}

    - name: Restore benchmark baseline cache
      uses: actions/cache/restore@v4
      with:
        path: coverage/benchmarks/baseline
        key: ${{ runner.os }}-bench-baseline-${{ github.ref_name }}-${{ github.run_id }}
        restore-keys: |
          ${{ runner.os }}-bench-baseline-${{ github.ref_name }}-
          ${{ runner.os }}-bench-baseline-main-

    - name: Run smoke benchmarks and generate report
      run: just bench-smoke-report

    - name: Enforce benchmark regression threshold
      run: |
        if [[ -f coverage/benchmarks/baseline/summary.json ]]; then
          export BENCH_WARN_PCT=5
          export BENCH_FAIL_PCT=10
          export BENCH_MIN_REGRESSION_NS=25000
          baseline_branch="unknown"
          if [[ -f coverage/benchmarks/baseline/branch.txt ]]; then
            baseline_branch="$(cat coverage/benchmarks/baseline/branch.txt)"
          fi

          if [[ "$baseline_branch" == "${{ github.ref_name }}" ]]; then
            echo "Benchmark gate: strict (baseline branch matches current branch: $baseline_branch)"
            just bench-report-check
          else
            echo "Benchmark gate: advisory only (baseline branch '$baseline_branch' != current '${{ github.ref_name }}')"
            if ! just bench-report-check; then
              echo "Non-blocking benchmark regression warning on cross-branch baseline."
            fi
          fi
        else
          echo "No prior benchmark baseline found; skipping regression enforcement for this run."
        fi

    - name: Update benchmark baseline
      run: |
        mkdir -p coverage/benchmarks/baseline
        cp coverage/benchmarks/summary.json coverage/benchmarks/baseline/summary.json
        echo "${{ github.ref_name }}" > coverage/benchmarks/baseline/branch.txt
        echo "${{ github.sha }}" > coverage/benchmarks/baseline/sha.txt

    - name: Save benchmark baseline cache
      uses: actions/cache/save@v4
      with:
        path: coverage/benchmarks/baseline
        key: ${{ runner.os }}-bench-baseline-${{ github.ref_name }}-${{ github.run_id }}

    - name: Upload benchmark artifacts
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-smoke-${{ github.run_id }}
        path: coverage/benchmarks

  # Summary job that branch protection can depend on
  ci-success:
    name: CI Success
    needs: [changes, check, test-unit, test-integration, coverage, benchmark-smoke]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check if all jobs succeeded
        run: |
          # If only docs changed, that's success
          if [[ "${{ needs.changes.outputs.code }}" == "false" ]]; then
            echo "Documentation-only change ✅"
            exit 0
          fi

          # Otherwise check that all CI jobs succeeded
          if [[ "${{ needs.check.result }}" != "success" ||
                "${{ needs.test-unit.result }}" != "success" ||
                "${{ needs.test-integration.result }}" != "success" ||
                "${{ needs.coverage.result }}" != "success" ||
                "${{ needs.benchmark-smoke.result }}" != "success" ]]; then
            echo "One or more jobs failed ❌"
            exit 1
          fi
          echo "All CI jobs passed successfully! ✅"
